<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¬ãƒ¼æ³¥æ£’ã‚²ãƒ¼ãƒ ï¼ˆæ¨ªç”»é¢ç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #87CEEB, #98FB98);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-height: 600px;
            margin: 0 auto;
            background: #f0f8ff;
            border: 2px solid #333;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        .screen.active {
            display: block !important;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #startScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #FFB347, #FF6347);
            color: white;
            text-align: center;
        }

        #startScreen h1 {
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #startScreen p {
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.5;
            max-width: 80%;
        }

        .start-button {
            padding: 15px 30px;
            font-size: 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: transform 0.1s ease;
        }

        .start-button:hover {
            transform: scale(1.05);
        }

        /* æ¨ªç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .shop-area {
            position: absolute;
            top: 50px;
            left: 100px;
            right: 100px;
            height: 300px;
            border: 3px solid #654321;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
        }

        .shop-header {
            position: relative;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .shop-title {
            background: white;
            padding: 8px 20px;
            border: 2px solid #333;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
        }

        .shopkeepers {
            display: flex;
            gap: 15px;
        }

        .shopkeeper {
            width: 50px;
            height: 60px;
            background: #FFE4B5;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .name-tag {
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #333;
            border-radius: 3px;
            padding: 1px 4px;
            font-size: 8px;
            font-weight: bold;
            color: #333;
            z-index: 10;
        }

        .eyes {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .eye {
            width: 10px;
            height: 10px;
            background: black;
            border-radius: 50%;
            transition: all 0.5s ease;
        }

        .eye.closed {
            height: 2px;
            background: #333;
        }

        .items-area {
            flex: 1;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 400px;
        }

        .item {
            width: 70px;
            height: 70px;
            border: 3px solid #333;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            background: white;
            transition: transform 0.1s ease;
        }

        .item:active {
            transform: scale(0.95);
        }

        .item.stolen {
            opacity: 0.3;
            pointer-events: none;
        }

        /* ã‚¨ãƒªã‚¢åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        .vegetable-shop {
            background: linear-gradient(135deg, #8B4513, #A0522D);
        }

        .supermarket {
            background: linear-gradient(135deg, #4169E1, #6495ED);
        }

        .convenience {
            background: linear-gradient(135deg, #32CD32, #90EE90);
        }

        /* UIé…ç½® */
        #gameUI {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #333;
            z-index: 100;
            min-width: 180px;
        }

        .ui-item {
            margin-bottom: 8px;
            font-weight: bold;
        }

        .ui-item:last-child {
            margin-bottom: 0;
        }

        .stage-indicator {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-block;
        }

        .alert-indicator {
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            display: inline-block;
        }

        .alert-indicator.safe {
            background: rgba(34, 139, 34, 0.8);
        }

        .alert-indicator.caution {
            background: rgba(255, 140, 0, 0.8);
        }

        .alert-indicator.warning {
            background: rgba(255, 69, 0, 0.8);
        }

        .alert-indicator.danger {
            background: rgba(220, 20, 60, 0.8);
        }

        /* é€šè¡Œäººã‚¨ãƒªã‚¢ */
        #walkArea {
            position: absolute;
            bottom: 120px;
            left: 0;
            right: 0;
            height: 80px;
            background: #90EE90;
            border-top: 2px solid #333;
            border-bottom: 2px solid #333;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .pedestrian {
            position: absolute;
            width: 50px;
            height: 65px;
            background: #87CEEB;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: walkLeft 8s linear infinite;
        }

        @keyframes walkLeft {
            from { left: 100%; }
            to { left: -80px; }
        }

        .pedestrian-item {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            cursor: pointer;
            background: white;
            border: 2px solid #333;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .pedestrian-item.stolen {
            opacity: 0.3;
            pointer-events: none;
        }

        /* æ³¥æ£’è¢‹ */
        #thiefBag {
            position: absolute;
            bottom: 15px;
            right: 15px;
            width: 100px;
            height: 100px;
            background: #8B4513;
            border: 3px solid #333;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .stolen-items {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin-top: 4px;
            font-size: 12px;
            max-width: 80px;
            justify-content: center;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 140, 0, 0.95);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            display: none;
            z-index: 1000;
        }

        /* çµæœç”»é¢ */
        #resultScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            text-align: center;
            padding: 20px;
            overflow-y: auto;
        }

        .result-title {
            font-size: 28px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .result-sections {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .result-section {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            min-width: 180px;
            max-width: 250px;
        }

        .result-section h3 {
            margin-bottom: 10px;
            color: #8B4513;
            font-size: 16px;
        }

        .result-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            font-size: 20px;
        }

        .final-result {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-width: 400px;
        }

        .restart-button {
            padding: 12px 24px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .drag-clone {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.8;
            transform: translate(-50%, -50%);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
        @media (max-width: 768px) {
            .shop-area {
                left: 20px;
                right: 20px;
                height: 250px;
            }
            
            .items {
                gap: 15px;
            }
            
            .item {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
            
            #gameUI {
                font-size: 14px;
                min-width: 160px;
            }
            
            .result-sections {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="startScreen" class="screen active">
            <h1>ğŸ› ã‚«ãƒ¬ãƒ¼æ³¥æ£’ã‚²ãƒ¼ãƒ  ğŸ›</h1>
            <p>
                æ¨ªç”»é¢ã§ã‚«ãƒ¬ãƒ¼ã®ææ–™ã‚’é›†ã‚ã¾ã—ã‚‡ã†ï¼<br>
                å…«ç™¾å±‹ã€ã‚¹ãƒ¼ãƒ‘ãƒ¼ã€ã‚³ãƒ³ãƒ“ãƒ‹ã‚’å„20ç§’ãšã¤å›ã£ã¦<br>
                è¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆã†ã«ææ–™ã‚’ç›—ã¿ã¾ã—ã‚‡ã†ï¼
            </p>
            <button class="start-button" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="gameScreen" class="screen">
            <!-- UI ã‚¨ãƒªã‚¢ -->
            <div id="gameUI">
                <div class="ui-item">æ™‚é–“: <span id="timeLeft">20</span>ç§’</div>
                <div class="ui-item">
                    <div class="stage-indicator" id="stageIndicator">å…«ç™¾å±‹ (1/3)</div>
                </div>
                <div class="ui-item">
                    <div class="alert-indicator safe" id="alertIndicator">è­¦æˆ’åº¦: 0/20</div>
                </div>
            </div>

            <!-- åº—ã‚¨ãƒªã‚¢ -->
            <div id="shopArea" class="shop-area vegetable-shop">
                <!-- åº—ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¨åº—å“¡ï¼‰ -->
                <div class="shop-header">
                    <div id="shopTitle" class="shop-title">å…«ç™¾å±‹ã‚¨ãƒªã‚¢</div>
                    <div class="shopkeepers">
                        <!-- ãƒ¡ã‚¤ãƒ³åº—å“¡ -->
                        <div id="shopkeeper" class="shopkeeper">
                            <div class="eyes">
                                <div class="eye" id="shopkeeperEye1"></div>
                                <div class="eye" id="shopkeeperEye2"></div>
                            </div>
                        </div>
                        
                        <!-- è¿½åŠ åº—å“¡ -->
                        <div id="secondShopkeeper" class="shopkeeper" style="display: none;">
                            <div class="name-tag">æ–°äºº</div>
                            <div class="eyes">
                                <div class="eye" id="secondShopkeeperEye1"></div>
                                <div class="eye" id="secondShopkeeperEye2"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚¢ã‚¤ãƒ†ãƒ ã‚¨ãƒªã‚¢ -->
                <div class="items-area">
                    <div id="items" class="items">
                        <!-- ã‚¢ã‚¤ãƒ†ãƒ ã¯å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- é€šè¡Œäººã‚¨ãƒªã‚¢ -->
            <div id="walkArea"></div>

            <!-- æ³¥æ£’è¢‹ -->
            <div id="thiefBag">
                <div>è¢‹</div>
                <div class="stolen-items" id="stolenItems"></div>
            </div>

            <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¡¨ç¤º -->
            <div id="gameOver">
                <div id="gameOverMessage">è¦‹ã¤ã‹ã£ã¦ã—ã¾ã„ã¾ã—ãŸï¼</div>
                <div id="gameOverSubMessage">é›†ã‚ãŸã‚¢ã‚¤ãƒ†ãƒ ãŒæ²¡åã•ã‚Œã¾ã™...</div>
            </div>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="resultScreen" class="screen">
            <div class="result-title">ğŸ› ã‚«ãƒ¬ãƒ¼æ³¥æ£’ çµæœç™ºè¡¨ ğŸ›</div>
            
            <div class="result-sections">
                <div class="result-section">
                    <h3>ğŸ¥• å…«ç™¾å±‹ã‚¨ãƒªã‚¢</h3>
                    <div class="result-items" id="vegetableResults"></div>
                </div>
                
                <div class="result-section">
                    <h3>ğŸ›’ ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¨ãƒªã‚¢</h3>
                    <div class="result-items" id="supermarketResults"></div>
                </div>
                
                <div class="result-section">
                    <h3>ğŸª ã‚³ãƒ³ãƒ“ãƒ‹ã‚¨ãƒªã‚¢</h3>
                    <div class="result-items" id="convenienceResults"></div>
                </div>
            </div>
            
            <div class="final-result">
                <h3>ğŸ“Š ç·åˆçµæœ</h3>
                <div>åˆè¨ˆã‚¢ã‚¤ãƒ†ãƒ æ•°: <span id="totalCount">0</span>å€‹</div>
                <div id="curryStatus"></div>
            </div>

            <button class="restart-button" onclick="restartGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
        const gameState = {
            running: false,
            timeLeft: 20,
            currentStage: 0,
            alertLevel: 0,
            shopkeeperWatching: true,
            secondShopkeeperWatching: true,
            secondShopkeeperVisible: false,
            pedestrians: [],
            allStolenItems: {
                vegetable: [],
                supermarket: [],
                convenience: []
            },
            dragData: {
                element: null,
                clone: null,
                startPos: { x: 0, y: 0 }
            },
            timers: {
                game: null,
                shopkeeper: null,
                secondShopkeeper: null,
                pedestrianSpawner: null
            }
        };

        // ã‚¨ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿
        const stageData = {
            0: {
                name: 'å…«ç™¾å±‹',
                title: 'å…«ç™¾å±‹ã‚¨ãƒªã‚¢',
                className: 'vegetable-shop',
                items: ['ğŸ¥•', 'ğŸ¥”', 'ğŸ§…', 'ğŸ¥¬', 'ğŸ…', 'ğŸ¥’'],
                pedestrianItems: ['ğŸ¥•', 'ğŸ¥”', 'ğŸ§…', 'ğŸ¥¬', 'ğŸ…', 'ğŸ¥’'],
                key: 'vegetable'
            },
            1: {
                name: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼',
                title: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¨ãƒªã‚¢',
                className: 'supermarket',
                items: ['ğŸš', 'ğŸ›', 'ğŸ¥š', 'ğŸ—', 'ğŸ§‚', 'ğŸ¯'],
                pedestrianItems: ['ğŸš', 'ğŸ›', 'ğŸ¥š', 'ğŸ—', 'ğŸ§‚', 'ğŸ¯'],
                key: 'supermarket'
            },
            2: {
                name: 'ã‚³ãƒ³ãƒ“ãƒ‹',
                title: 'ã‚³ãƒ³ãƒ“ãƒ‹ã‚¨ãƒªã‚¢',
                className: 'convenience',
                items: ['ğŸ§´', 'ğŸ«', 'ğŸª', 'ğŸ', 'ğŸ”‹', 'ğŸ“–'],
                pedestrianItems: ['ğŸ§´', 'ğŸ«', 'ğŸª', 'ğŸ', 'ğŸ”‹', 'ğŸ“–'],
                key: 'convenience'
            }
        };

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
                screen.style.display = 'none';
            });
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                targetScreen.style.display = 'block';
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            showScreen('gameScreen');
            gameState.currentStage = 0;
            gameState.alertLevel = 0;
            gameState.secondShopkeeperVisible = false;
            gameState.allStolenItems = { vegetable: [], supermarket: [], convenience: [] };
            
            document.getElementById('secondShopkeeper').style.display = 'none';
            setupStage();
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupStage() {
            clearAllTimers();
            resetGameState();
            
            const stage = stageData[gameState.currentStage];
            
            // UIæ›´æ–°
            document.getElementById('shopTitle').textContent = stage.title;
            document.getElementById('stageIndicator').textContent = `${stage.name} (${gameState.currentStage + 1}/3)`;
            
            // ã‚¨ãƒªã‚¢ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
            const shopArea = document.getElementById('shopArea');
            shopArea.className = `shop-area ${stage.className}`;
            
            // ã‚¢ã‚¤ãƒ†ãƒ é…ç½®
            setupItems(stage.items);
            
            updateUI();
            startTimers();
        }

        // ã‚¢ã‚¤ãƒ†ãƒ é…ç½®
        function setupItems(items) {
            const container = document.getElementById('items');
            container.innerHTML = '';
            
            items.forEach(item => {
                const element = document.createElement('div');
                element.className = 'item';
                element.dataset.item = item;
                element.textContent = item;
                container.appendChild(element);
            });
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        function resetGameState() {
            gameState.running = true;
            gameState.timeLeft = 20;
            gameState.shopkeeperWatching = true;
            gameState.secondShopkeeperWatching = true;
            gameState.secondShopkeeperVisible = gameState.alertLevel >= 10;
            gameState.pedestrians = [];
            gameState.dragData = { element: null, clone: null, startPos: { x: 0, y: 0 } };
            
            // UI ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('stolenItems').innerHTML = '';
            document.getElementById('walkArea').innerHTML = '';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('shopkeeperEye1').classList.remove('closed');
            document.getElementById('shopkeeperEye2').classList.remove('closed');
            document.getElementById('secondShopkeeperEye1').classList.remove('closed');
            document.getElementById('secondShopkeeperEye2').classList.remove('closed');
            
            // è¿½åŠ åº—å“¡è¡¨ç¤ºçŠ¶æ…‹æ›´æ–°
            if (gameState.secondShopkeeperVisible) {
                document.getElementById('secondShopkeeper').style.display = 'flex';
            } else {
                document.getElementById('secondShopkeeper').style.display = 'none';
            }
            
            updateAlertLevelUI();
        }

        // è­¦æˆ’åº¦ã«å¿œã˜ãŸç¬ãã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨ˆç®—
        function getBlinkTimings() {
            const alertRatio = Math.min(gameState.alertLevel / 20, 1);
            
            const closeMin = 2000 + (alertRatio * 2000);
            const closeMax = 4000 + (alertRatio * 4000);
            const closeTime = Math.random() * (closeMax - closeMin) + closeMin;
            
            const openMin = 2000 - (alertRatio * 1500);
            const openMax = 4000 - (alertRatio * 3000);
            const openTime = Math.random() * (openMax - openMin) + openMin;
            
            return { closeTime, openTime };
        }

        // è­¦æˆ’åº¦UIæ›´æ–°
        function updateAlertLevelUI() {
            const alertIndicator = document.getElementById('alertIndicator');
            if (alertIndicator) {
                alertIndicator.textContent = `è­¦æˆ’åº¦: ${gameState.alertLevel}/20`;
                
                alertIndicator.className = 'alert-indicator';
                
                if (gameState.alertLevel <= 4) {
                    alertIndicator.classList.add('safe');
                } else if (gameState.alertLevel <= 9) {
                    alertIndicator.classList.add('caution');
                } else if (gameState.alertLevel <= 14) {
                    alertIndicator.classList.add('warning');
                } else {
                    alertIndicator.classList.add('danger');
                }
            }
            
            // è­¦æˆ’åº¦10ã§è¿½åŠ åº—å“¡è¡¨ç¤º
            if (gameState.alertLevel >= 10 && !gameState.secondShopkeeperVisible) {
                gameState.secondShopkeeperVisible = true;
                document.getElementById('secondShopkeeper').style.display = 'flex';
                startSecondShopkeeperBlinking();
            }
        }

        // å…¨ã‚¿ã‚¤ãƒãƒ¼ã‚¯ãƒªã‚¢
        function clearAllTimers() {
            Object.values(gameState.timers).forEach(timer => {
                if (timer) clearInterval(timer);
            });
            gameState.timers = { game: null, shopkeeper: null, secondShopkeeper: null, pedestrianSpawner: null };
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimers() {
            startGameTimer();
            startShopkeeperBlinking();
            if (gameState.secondShopkeeperVisible) {
                startSecondShopkeeperBlinking();
            }
            startPedestrianSpawning();
        }

        // ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒãƒ¼
        function startGameTimer() {
            gameState.timers.game = setInterval(() => {
                if (!gameState.running) return;
                gameState.timeLeft--;
                updateUI();
                if (gameState.timeLeft <= 0) nextStageOrEnd();
            }, 1000);
        }

        // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¾ãŸã¯çµ‚äº†
        function nextStageOrEnd() {
            gameState.running = false;
            clearAllTimers();
            
            if (gameState.currentStage < 2) {
                gameState.currentStage++;
                setTimeout(() => setupStage(), 1000);
            } else {
                showResults();
            }
        }

        // ãƒ¡ã‚¤ãƒ³åº—å“¡ã®ç¬ã
        function startShopkeeperBlinking() {
            function blink() {
                if (!gameState.running) return;
                
                const timings = getBlinkTimings();
                
                gameState.timers.shopkeeper = setTimeout(() => {
                    if (!gameState.running) return;
                    
                    gameState.shopkeeperWatching = false;
                    document.getElementById('shopkeeperEye1').classList.add('closed');
                    document.getElementById('shopkeeperEye2').classList.add('closed');
                    
                    gameState.timers.shopkeeper = setTimeout(() => {
                        if (!gameState.running) return;
                        
                        document.getElementById('shopkeeperEye1').classList.remove('closed');
                        document.getElementById('shopkeeperEye2').classList.remove('closed');
                        
                        setTimeout(() => {
                            if (!gameState.running) return;
                            gameState.shopkeeperWatching = true;
                        }, 500);
                        
                        blink();
                    }, timings.openTime);
                }, timings.closeTime);
            }
            blink();
        }

        // è¿½åŠ åº—å“¡ã®ç¬ã
        function startSecondShopkeeperBlinking() {
            function blink() {
                if (!gameState.running || !gameState.secondShopkeeperVisible) return;
                
                const closeTime = Math.random() * 1000 + 1000;
                
                gameState.timers.secondShopkeeper = setTimeout(() => {
                    if (!gameState.running || !gameState.secondShopkeeperVisible) return;
                    
                    gameState.secondShopkeeperWatching = false;
                    document.getElementById('secondShopkeeperEye1').classList.add('closed');
                    document.getElementById('secondShopkeeperEye2').classList.add('closed');
                    
                    const openTime = Math.random() * 2000 + 2000;
                    
                    gameState.timers.secondShopkeeper = setTimeout(() => {
                        if (!gameState.running || !gameState.secondShopkeeperVisible) return;
                        
                        document.getElementById('secondShopkeeperEye1').classList.remove('closed');
                        document.getElementById('secondShopkeeperEye2').classList.remove('closed');
                        
                        setTimeout(() => {
                            if (!gameState.running || !gameState.secondShopkeeperVisible) return;
                            gameState.secondShopkeeperWatching = true;
                        }, 500);
                        
                        blink();
                    }, openTime);
                }, closeTime);
            }
            blink();
        }

        // é€šè¡Œäººç”Ÿæˆ
        function startPedestrianSpawning() {
            createPedestrian();
            gameState.timers.pedestrianSpawner = setInterval(() => {
                if (!gameState.running) return;
                createPedestrian();
            }, 3000);
        }

        // é€šè¡Œäººä½œæˆ
        function createPedestrian() {
            if (!gameState.running) return;

            const stage = stageData[gameState.currentStage];
            const pedestrian = document.createElement('div');
            pedestrian.className = 'pedestrian';
            
            const eyes = document.createElement('div');
            eyes.className = 'eyes';
            ['eye1', 'eye2'].forEach(id => {
                const eye = document.createElement('div');
                eye.className = 'eye';
                eye.id = id;
                eyes.appendChild(eye);
                pedestrian[id] = eye;
            });

            // ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ
            let item;
            if (gameState.currentStage === 1 && Math.random() < 0.03) {
                item = 'ğŸ’'; // ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§3%ã®ç¢ºç‡ã§ãƒ€ã‚¤ã‚¢ãƒ¢ãƒ³ãƒ‰
            } else {
                const items = stage.pedestrianItems;
                item = items[Math.floor(Math.random() * items.length)];
            }
            
            const itemElement = document.createElement('div');
            itemElement.className = 'pedestrian-item';
            itemElement.textContent = item;
            itemElement.dataset.item = item;

            pedestrian.appendChild(eyes);
            pedestrian.appendChild(itemElement);
            pedestrian.watching = true;

            document.getElementById('walkArea').appendChild(pedestrian);
            gameState.pedestrians.push(pedestrian);

            startPedestrianBlinking(pedestrian);

            setTimeout(() => {
                if (pedestrian.parentNode) {
                    pedestrian.parentNode.removeChild(pedestrian);
                    const index = gameState.pedestrians.indexOf(pedestrian);
                    if (index > -1) gameState.pedestrians.splice(index, 1);
                }
            }, 8000);
        }

        // é€šè¡Œäººã®ç¬ã
        function startPedestrianBlinking(pedestrian) {
            function blink() {
                if (!gameState.running || !pedestrian.parentNode) return;
                
                const timings = getBlinkTimings();
                
                setTimeout(() => {
                    if (!gameState.running || !pedestrian.parentNode) return;
                    
                    pedestrian.watching = false;
                    pedestrian.eye1.classList.add('closed');
                    pedestrian.eye2.classList.add('closed');
                    
                    setTimeout(() => {
                        if (!gameState.running || !pedestrian.parentNode) return;
                        
                        pedestrian.eye1.classList.remove('closed');
                        pedestrian.eye2.classList.remove('closed');
                        
                        setTimeout(() => {
                            if (!gameState.running || !pedestrian.parentNode) return;
                            pedestrian.watching = true;
                        }, 500);
                        
                        blink();
                    }, timings.openTime);
                }, timings.closeTime);
            }
            blink();
        }

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        function setupTouchEvents() {
            const container = document.getElementById('gameContainer');
            
            container.addEventListener('touchstart', handleTouchStart, { passive: false });
            container.addEventListener('mousedown', handleTouchStart);
            container.addEventListener('touchmove', handleTouchMove, { passive: false });
            container.addEventListener('mousemove', handleTouchMove);
            container.addEventListener('touchend', handleTouchEnd, { passive: false });
            container.addEventListener('mouseup', handleTouchEnd);
        }

        // ã‚¿ãƒƒãƒé–‹å§‹
        function handleTouchStart(e) {
            if (!gameState.running) return;
            
            const touch = e.touches ? e.touches[0] : e;
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (!isValidItem(target)) return;
            
            if (isBeingWatched(target)) {
                gameOver();
                return;
            }
            
            gameState.dragData.element = target;
            gameState.dragData.startPos = { x: touch.clientX, y: touch.clientY };
            createDragClone(target, touch.clientX, touch.clientY);
            e.preventDefault();
        }

        // ã‚¿ãƒƒãƒç§»å‹•
        function handleTouchMove(e) {
            if (!gameState.dragData.element || !gameState.dragData.clone) return;
            
            const touch = e.touches ? e.touches[0] : e;
            gameState.dragData.clone.style.left = touch.clientX + 'px';
            gameState.dragData.clone.style.top = touch.clientY + 'px';
            e.preventDefault();
        }

        // ã‚¿ãƒƒãƒçµ‚äº†
        function handleTouchEnd(e) {
            if (!gameState.dragData.element) {
                removeDragClone();
                return;
            }
            
            const touch = e.changedTouches ? e.changedTouches[0] : e;
            const endPos = { x: touch.clientX, y: touch.clientY };
            const distance = calculateDistance(gameState.dragData.startPos, endPos);
            
            if (distance > 30 && isOverThiefBag(endPos.x, endPos.y)) {
                stealItem(gameState.dragData.element);
            }
            
            removeDragClone();
            gameState.dragData.element = null;
            e.preventDefault();
        }

        // æœ‰åŠ¹ãªã‚¢ã‚¤ãƒ†ãƒ ã‹ãƒã‚§ãƒƒã‚¯
        function isValidItem(element) {
            return element && 
                   (element.classList.contains('item') || element.classList.contains('pedestrian-item')) &&
                   !element.classList.contains('stolen');
        }

        // è¦‹å¼µã‚‰ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        function isBeingWatched(element) {
            if (element.classList.contains('item')) {
                const mainShopkeeperWatching = gameState.shopkeeperWatching;
                const secondShopkeeperWatching = gameState.secondShopkeeperVisible && gameState.secondShopkeeperWatching;
                return mainShopkeeperWatching || secondShopkeeperWatching;
            } else if (element.classList.contains('pedestrian-item')) {
                const pedestrian = element.parentNode;
                return pedestrian && pedestrian.watching;
            }
            return false;
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚¯ãƒ­ãƒ¼ãƒ³ä½œæˆ
        function createDragClone(element, x, y) {
            gameState.dragData.clone = element.cloneNode(true);
            gameState.dragData.clone.className = element.className + ' drag-clone';
            gameState.dragData.clone.style.left = x + 'px';
            gameState.dragData.clone.style.top = y + 'px';
            document.body.appendChild(gameState.dragData.clone);
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚¯ãƒ­ãƒ¼ãƒ³å‰Šé™¤
        function removeDragClone() {
            if (gameState.dragData.clone) {
                document.body.removeChild(gameState.dragData.clone);
                gameState.dragData.clone = null;
            }
        }

        // è·é›¢è¨ˆç®—
        function calculateDistance(pos1, pos2) {
            return Math.sqrt(Math.pow(pos2.x - pos1.x, 2) + Math.pow(pos2.y - pos1.y, 2));
        }

        // æ³¥æ£’è¢‹ã®ä¸Šã‹ãƒã‚§ãƒƒã‚¯
        function isOverThiefBag(x, y) {
            const bag = document.getElementById('thiefBag');
            const rect = bag.getBoundingClientRect();
            const margin = 10;
            return x >= (rect.left - margin) && x <= (rect.right + margin) &&
                   y >= (rect.top - margin) && y <= (rect.bottom + margin);
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç›—ã‚€
        function stealItem(element) {
            if (!element || element.classList.contains('stolen')) return;
            
            const item = element.dataset.item;
            const stage = stageData[gameState.currentStage];
            
            gameState.allStolenItems[stage.key].push(item);
            
            // è­¦æˆ’åº¦ä¸Šæ˜‡
            if (gameState.alertLevel < 20) {
                gameState.alertLevel++;
                updateAlertLevelUI();
            }
            
            const stolenItems = document.getElementById('stolenItems');
            const itemSpan = document.createElement('span');
            itemSpan.textContent = item;
            stolenItems.appendChild(itemSpan);
            
            // ã‚¢ã‚¤ãƒ†ãƒ çŠ¶æ…‹æ›´æ–°
            if (element.classList.contains('pedestrian-item')) {
                element.classList.add('stolen');
            } else if (element.classList.contains('item')) {
                element.classList.add('stolen');
                element.style.opacity = '0.3';
                
                setTimeout(() => {
                    if (element && gameState.running) {
                        element.classList.remove('stolen');
                        element.style.opacity = '1';
                    }
                }, 3000);
            }
        }

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
        function gameOver() {
            gameState.running = false;
            clearAllTimers();
            removeDragClone();
            
            const stage = stageData[gameState.currentStage];
            gameState.allStolenItems[stage.key] = [];
            
            document.getElementById('stolenItems').innerHTML = '';
            
            document.getElementById('gameOverMessage').textContent = 'è¦‹ã¤ã‹ã£ã¦ã—ã¾ã„ã¾ã—ãŸï¼';
            document.getElementById('gameOverSubMessage').textContent = `${stage.name}ã‚¨ãƒªã‚¢ã§é›†ã‚ãŸã‚¢ã‚¤ãƒ†ãƒ ãŒæ²¡åã•ã‚Œã¾ã™...`;
            document.getElementById('gameOver').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('gameOver').style.display = 'none';
                
                if (gameState.currentStage < 2) {
                    gameState.currentStage++;
                    setupStage();
                } else {
                    showResults();
                }
            }, 2000);
        }

        // çµæœè¡¨ç¤º
        function showResults() {
            document.getElementById('vegetableResults').innerHTML = 
                gameState.allStolenItems.vegetable.length ? 
                gameState.allStolenItems.vegetable.map(item => `<span>${item}</span>`).join('') : 
                '<span style="color: #999;">ãªã—</span>';
                
            document.getElementById('supermarketResults').innerHTML = 
                gameState.allStolenItems.supermarket.length ? 
                gameState.allStolenItems.supermarket.map(item => `<span>${item}</span>`).join('') : 
                '<span style="color: #999;">ãªã—</span>';
                
            document.getElementById('convenienceResults').innerHTML = 
                gameState.allStolenItems.convenience.length ? 
                gameState.allStolenItems.convenience.map(item => `<span>${item}</span>`).join('') : 
                '<span style="color: #999;">ãªã—</span>';
            
            const totalCount = gameState.allStolenItems.vegetable.length + 
                             gameState.allStolenItems.supermarket.length + 
                             gameState.allStolenItems.convenience.length;
            
            document.getElementById('totalCount').textContent = totalCount;
            
            // ã‚«ãƒ¬ãƒ¼è©•ä¾¡
            let curryStatus = '';
            if (totalCount >= 15) {
                curryStatus = 'ğŸŒŸ å®Œç’§ãªã‚«ãƒ¬ãƒ¼ã®ææ–™ãŒæƒã„ã¾ã—ãŸï¼';
            } else if (totalCount >= 10) {
                curryStatus = 'ğŸ˜Š ãªã‹ãªã‹è‰¯ã„ã‚«ãƒ¬ãƒ¼ãŒä½œã‚Œãã†ã§ã™ï¼';
            } else if (totalCount >= 5) {
                curryStatus = 'ğŸ˜… è³ªç´ ãªã‚«ãƒ¬ãƒ¼ã«ãªã‚Šãã†ã§ã™...';
            } else {
                curryStatus = 'ğŸ˜± ã‚«ãƒ¬ãƒ¼ã‚’ä½œã‚‹ã«ã¯ææ–™ãŒè¶³ã‚Šã¾ã›ã‚“ï¼';
            }
            
            document.getElementById('curryStatus').textContent = curryStatus;
            
            showScreen('resultScreen');
        }

        // ã‚²ãƒ¼ãƒ å†é–‹
        function restartGame() {
            clearAllTimers();
            removeDragClone();
            
            document.getElementById('gameOver').style.display = 'none';
            
            gameState.alertLevel = 0;
            gameState.secondShopkeeperVisible = false;
            gameState.secondShopkeeperWatching = true;
            
            document.getElementById('secondShopkeeper').style.display = 'none';
            
            showScreen('startScreen');
        }

        // UIæ›´æ–°
        function updateUI() {
            document.getElementById('timeLeft').textContent = gameState.timeLeft;
            updateAlertLevelUI();
        }

        // åˆæœŸåŒ–
        setupTouchEvents();
        
        document.addEventListener('DOMContentLoaded', function() {
            showScreen('startScreen');
        });
        
        window.addEventListener('load', function() {
            showScreen('startScreen');
        });
    </script>
</body>
</html>
