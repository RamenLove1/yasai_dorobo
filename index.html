<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈáéËèúÊ≥•Ê£í„Ç≤„Éº„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #87CEEB, #98FB98);
            overflow: hidden;
            height: 100vh;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 400px;
            margin: 0 auto;
            background: #f0f8ff;
            border: 2px solid #333;
        }

        #shopArea {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            height: 200px;
            background: #8B4513;
            border: 3px solid #654321;
            border-radius: 10px;
        }

        #shopTitle {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 5px 15px;
            border: 2px solid #333;
            border-radius: 15px;
            font-weight: bold;
        }

        #shopkeeper {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 80px;
            background: #FFE4B5;
            border: 2px solid #333;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .eyes {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .eye {
            width: 12px;
            height: 12px;
            background: black;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .eye.closed {
            height: 2px;
            background: #333;
        }

        #vegetables {
            position: absolute;
            top: 30px;
            left: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 200px;
        }

        .vegetable {
            width: 60px;
            height: 60px;
            border: 3px solid #333;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            background: white;
            transition: transform 0.1s ease;
        }

        .vegetable:active {
            transform: scale(0.95);
        }

        .vegetable.stolen {
            opacity: 0.3;
            pointer-events: none;
        }

        #walkArea {
            position: absolute;
            top: 240px;
            left: 0;
            right: 0;
            height: 100px;
            background: #90EE90;
            border-top: 2px solid #333;
            overflow: hidden;
            padding-top: 30px;
        }

        .pedestrian {
            position: absolute;
            width: 60px;
            height: 80px;
            background: #87CEEB;
            border: 2px solid #333;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: walkLeft 8s linear infinite;
        }

        @keyframes walkLeft {
            from { left: 100%; }
            to { left: -80px; }
        }

        .pedestrian-vegetable {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            cursor: pointer;
            background: white;
            border: 3px solid #333;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .pedestrian-vegetable.stolen {
            opacity: 0.3;
            pointer-events: none;
        }

        #thiefBag {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 120px;
            background: #8B4513;
            border: 4px solid #333;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        #gameUI {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #333;
        }

        #gameOver, #gameComplete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            display: none;
            z-index: 1000;
        }

        #gameOver {
            background: rgba(255, 0, 0, 0.9);
            color: white;
        }

        #gameComplete {
            background: rgba(0, 200, 0, 0.9);
            color: white;
        }

        button {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
        }

        .stolen-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            font-size: 16px;
        }

        .drag-clone {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.8;
            transform: translate(-50%, -50%);
        }

        .result-stolen {
            margin: 15px 0;
            font-size: 18px;
        }

        .result-stolen-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="shopArea">
            <div id="shopTitle">ÂÖ´ÁôæÂ±ã„Ç®„É™„Ç¢</div>
            <div id="shopkeeper">
                <div class="eyes">
                    <div class="eye" id="shopkeeperEye1"></div>
                    <div class="eye" id="shopkeeperEye2"></div>
                </div>
            </div>
            <div id="vegetables">
                <div class="vegetable" data-vegetable="ü•ï">ü•ï</div>
                <div class="vegetable" data-vegetable="ü•î">ü•î</div>
                <div class="vegetable" data-vegetable="üßÖ">üßÖ</div>
                <div class="vegetable" data-vegetable="ü•¨">ü•¨</div>
                <div class="vegetable" data-vegetable="üçÖ">üçÖ</div>
                <div class="vegetable" data-vegetable="ü•í">ü•í</div>
            </div>
        </div>

        <div id="walkArea"></div>

        <div id="thiefBag">
            <div>Ê≥•Ê£íË¢ã</div>
            <div class="stolen-items" id="stolenItems"></div>
        </div>

        <div id="gameUI">
            <div>ÊôÇÈñì: <span id="timeLeft">20</span>Áßí</div>
        </div>

        <div id="gameOver">
            <div>„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅ</div>
            <div>Ë¶ã„Å§„Åã„Å£„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü</div>
            <div class="result-stolen">
                <div>Áõó„Çì„Å†ÈáéËèú:</div>
                <div class="result-stolen-items" id="gameOverStolenItems"></div>
            </div>
            <button onclick="restartGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
        </div>

        <div id="gameComplete">
            <div>ÊôÇÈñìÁµÇ‰∫ÜÔºÅ</div>
            <div class="result-stolen">
                <div>Áõó„Çì„Å†ÈáéËèú:</div>
                <div class="result-stolen-items" id="gameCompleteStolenItems"></div>
            </div>
            <button onclick="restartGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
        </div>
    </div>

    <script>
        // „Ç≤„Éº„É†Áä∂ÊÖã
        const gameState = {
            running: false,
            timeLeft: 20,
            shopkeeperWatching: true,
            pedestrians: [],
            stolenVegetables: [],
            dragData: {
                element: null,
                clone: null,
                startPos: { x: 0, y: 0 }
            },
            timers: {
                game: null,
                shopkeeper: null,
                pedestrianSpawner: null
            }
        };

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            clearAllTimers();
            resetGameState();
            updateUI();
            startTimers();
        }

        // „Ç≤„Éº„É†Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
        function resetGameState() {
            gameState.running = true;
            gameState.timeLeft = 20;
            gameState.shopkeeperWatching = true;
            gameState.pedestrians = [];
            gameState.stolenVegetables = [];
            gameState.dragData = { element: null, clone: null, startPos: { x: 0, y: 0 } };
        }

        // ÂÖ®„Çø„Ç§„Éû„Éº„ÇØ„É™„Ç¢
        function clearAllTimers() {
            Object.values(gameState.timers).forEach(timer => {
                if (timer) clearInterval(timer);
            });
            gameState.timers = { game: null, shopkeeper: null, pedestrianSpawner: null };
        }

        // „Çø„Ç§„Éû„ÉºÈñãÂßã
        function startTimers() {
            startGameTimer();
            startShopkeeperBlinking();
            startPedestrianSpawning();
        }

        // „Ç≤„Éº„É†„Çø„Ç§„Éû„Éº
        function startGameTimer() {
            gameState.timers.game = setInterval(() => {
                if (!gameState.running) return;
                gameState.timeLeft--;
                updateUI();
                if (gameState.timeLeft <= 0) endGame();
            }, 1000);
        }

        // ÂÖ´ÁôæÂ±ã„ÅÆÁû¨„Åç
        function startShopkeeperBlinking() {
            function blink() {
                if (!gameState.running) return;
                gameState.timers.shopkeeper = setTimeout(() => {
                    if (!gameState.running) return;
                    gameState.shopkeeperWatching = false;
                    document.getElementById('shopkeeperEye1').classList.add('closed');
                    document.getElementById('shopkeeperEye2').classList.add('closed');
                    
                    gameState.timers.shopkeeper = setTimeout(() => {
                        if (!gameState.running) return;
                        gameState.shopkeeperWatching = true;
                        document.getElementById('shopkeeperEye1').classList.remove('closed');
                        document.getElementById('shopkeeperEye2').classList.remove('closed');
                        blink();
                    }, Math.random() * 2000 + 1000);
                }, Math.random() * 4000 + 1000);
            }
            blink();
        }

        // ÈÄöË°å‰∫∫ÁîüÊàê
        function startPedestrianSpawning() {
            createPedestrian(); // ÊúÄÂàù„ÅÆÈÄöË°å‰∫∫
            gameState.timers.pedestrianSpawner = setInterval(() => {
                if (!gameState.running) return;
                createPedestrian();
            }, 3000);
        }

        // ÈÄöË°å‰∫∫‰ΩúÊàê
        function createPedestrian() {
            if (!gameState.running) return;

            const pedestrian = document.createElement('div');
            pedestrian.className = 'pedestrian';
            
            const eyes = document.createElement('div');
            eyes.className = 'eyes';
            ['eye1', 'eye2'].forEach(id => {
                const eye = document.createElement('div');
                eye.className = 'eye';
                eye.id = id;
                eyes.appendChild(eye);
                pedestrian[id] = eye;
            });

            const vegetables = ['ü•ï', 'ü•î', 'üßÖ', 'ü•¨', 'üçÖ', 'ü•í'];
            const veggie = vegetables[Math.floor(Math.random() * vegetables.length)];
            const vegetableElement = document.createElement('div');
            vegetableElement.className = 'pedestrian-vegetable';
            vegetableElement.textContent = veggie;
            vegetableElement.dataset.vegetable = veggie;

            pedestrian.appendChild(eyes);
            pedestrian.appendChild(vegetableElement);
            pedestrian.watching = true;

            document.getElementById('walkArea').appendChild(pedestrian);
            gameState.pedestrians.push(pedestrian);

            // Áû¨„ÅçÂà∂Âæ°
            startPedestrianBlinking(pedestrian);

            // 8ÁßíÂæå„Å´ÂâäÈô§
            setTimeout(() => {
                if (pedestrian.parentNode) {
                    pedestrian.parentNode.removeChild(pedestrian);
                    const index = gameState.pedestrians.indexOf(pedestrian);
                    if (index > -1) gameState.pedestrians.splice(index, 1);
                }
            }, 8000);
        }

        // ÈÄöË°å‰∫∫„ÅÆÁû¨„Åç
        function startPedestrianBlinking(pedestrian) {
            function blink() {
                if (!gameState.running || !pedestrian.parentNode) return;
                setTimeout(() => {
                    if (!gameState.running || !pedestrian.parentNode) return;
                    pedestrian.watching = false;
                    pedestrian.eye1.classList.add('closed');
                    pedestrian.eye2.classList.add('closed');
                    
                    setTimeout(() => {
                        if (!gameState.running || !pedestrian.parentNode) return;
                        pedestrian.watching = true;
                        pedestrian.eye1.classList.remove('closed');
                        pedestrian.eye2.classList.remove('closed');
                        blink();
                    }, Math.random() * 2000 + 1000);
                }, Math.random() * 4000 + 1000);
            }
            blink();
        }

        // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
        function setupTouchEvents() {
            const container = document.getElementById('gameContainer');
            
            container.addEventListener('touchstart', handleTouchStart, { passive: false });
            container.addEventListener('mousedown', handleTouchStart);
            container.addEventListener('touchmove', handleTouchMove, { passive: false });
            container.addEventListener('mousemove', handleTouchMove);
            container.addEventListener('touchend', handleTouchEnd, { passive: false });
            container.addEventListener('mouseup', handleTouchEnd);
        }

        // „Çø„ÉÉ„ÉÅÈñãÂßã
        function handleTouchStart(e) {
            if (!gameState.running) return;
            
            const touch = e.touches ? e.touches[0] : e;
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (!isValidVegetable(target)) return;
            
            // Ë¶ãÂºµ„Çä„ÉÅ„Çß„ÉÉ„ÇØ
            if (isBeingWatched(target)) {
                gameOver();
                return;
            }
            
            // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
            gameState.dragData.element = target;
            gameState.dragData.startPos = { x: touch.clientX, y: touch.clientY };
            createDragClone(target, touch.clientX, touch.clientY);
            e.preventDefault();
        }

        // „Çø„ÉÉ„ÉÅÁßªÂãï
        function handleTouchMove(e) {
            if (!gameState.dragData.element || !gameState.dragData.clone) return;
            
            const touch = e.touches ? e.touches[0] : e;
            gameState.dragData.clone.style.left = touch.clientX + 'px';
            gameState.dragData.clone.style.top = touch.clientY + 'px';
            e.preventDefault();
        }

        // „Çø„ÉÉ„ÉÅÁµÇ‰∫Ü
        function handleTouchEnd(e) {
            if (!gameState.dragData.element) {
                removeDragClone();
                return;
            }
            
            const touch = e.changedTouches ? e.changedTouches[0] : e;
            const endPos = { x: touch.clientX, y: touch.clientY };
            const distance = calculateDistance(gameState.dragData.startPos, endPos);
            
            if (distance > 30 && isOverThiefBag(endPos.x, endPos.y)) {
                stealVegetable(gameState.dragData.element);
            }
            
            removeDragClone();
            gameState.dragData.element = null;
            e.preventDefault();
        }

        // ÊúâÂäπ„Å™ÈáéËèú„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isValidVegetable(element) {
            return element && 
                   (element.classList.contains('vegetable') || element.classList.contains('pedestrian-vegetable')) &&
                   !element.classList.contains('stolen');
        }

        // Ë¶ãÂºµ„Çâ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isBeingWatched(element) {
            if (element.classList.contains('vegetable')) {
                return gameState.shopkeeperWatching;
            } else if (element.classList.contains('pedestrian-vegetable')) {
                const pedestrian = element.parentNode;
                return pedestrian && pedestrian.watching;
            }
            return false;
        }

        // „Éâ„É©„ÉÉ„Ç∞„ÇØ„É≠„Éº„É≥‰ΩúÊàê
        function createDragClone(element, x, y) {
            gameState.dragData.clone = element.cloneNode(true);
            gameState.dragData.clone.className = element.className + ' drag-clone';
            gameState.dragData.clone.style.left = x + 'px';
            gameState.dragData.clone.style.top = y + 'px';
            document.body.appendChild(gameState.dragData.clone);
        }

        // „Éâ„É©„ÉÉ„Ç∞„ÇØ„É≠„Éº„É≥ÂâäÈô§
        function removeDragClone() {
            if (gameState.dragData.clone) {
                document.body.removeChild(gameState.dragData.clone);
                gameState.dragData.clone = null;
            }
        }

        // Ë∑ùÈõ¢Ë®àÁÆó
        function calculateDistance(pos1, pos2) {
            return Math.sqrt(Math.pow(pos2.x - pos1.x, 2) + Math.pow(pos2.y - pos1.y, 2));
        }

        // Ê≥•Ê£íË¢ã„ÅÆ‰∏ä„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isOverThiefBag(x, y) {
            const bag = document.getElementById('thiefBag');
            const rect = bag.getBoundingClientRect();
            const margin = 10;
            return x >= (rect.left - margin) && x <= (rect.right + margin) &&
                   y >= (rect.top - margin) && y <= (rect.bottom + margin);
        }

        // ÈáéËèú„ÇíÁõó„ÇÄ
        function stealVegetable(element) {
            if (!element || element.classList.contains('stolen')) return;
            
            const vegetable = element.dataset.vegetable;
            gameState.stolenVegetables.push(vegetable);
            
            const stolenItems = document.getElementById('stolenItems');
            const item = document.createElement('span');
            item.textContent = vegetable;
            stolenItems.appendChild(item);
            
            element.classList.add('stolen');
        }

        // Áõó„Çì„Å†ÈáéËèú„ÇíË°®Á§∫
        function displayStolenVegetables(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (gameState.stolenVegetables.length === 0) {
                container.textContent = '„Å™„Åó';
                container.style.color = '#666';
            } else {
                gameState.stolenVegetables.forEach(vegetable => {
                    const item = document.createElement('span');
                    item.textContent = vegetable;
                    container.appendChild(item);
                });
            }
        }

        // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
        function gameOver() {
            gameState.running = false;
            clearAllTimers();
            removeDragClone();
            displayStolenVegetables('gameOverStolenItems');
            document.getElementById('gameOver').style.display = 'block';
        }

        // „Ç≤„Éº„É†ÁµÇ‰∫Ü
        function endGame() {
            gameState.running = false;
            clearAllTimers();
            removeDragClone();
            displayStolenVegetables('gameCompleteStolenItems');
            document.getElementById('gameComplete').style.display = 'block';
        }

        // „Ç≤„Éº„É†ÂÜçÈñã
        function restartGame() {
            clearAllTimers();
            removeDragClone();
            
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameComplete').style.display = 'none';
            document.getElementById('stolenItems').innerHTML = '';
            
            document.querySelectorAll('.vegetable').forEach(veg => veg.classList.remove('stolen'));
            document.getElementById('walkArea').innerHTML = '';
            document.getElementById('shopkeeperEye1').classList.remove('closed');
            document.getElementById('shopkeeperEye2').classList.remove('closed');
            
            initGame();
        }

        // UIÊõ¥Êñ∞
        function updateUI() {
            document.getElementById('timeLeft').textContent = gameState.timeLeft;
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        setupTouchEvents();
        initGame();
    </script>
</body>
</html>
